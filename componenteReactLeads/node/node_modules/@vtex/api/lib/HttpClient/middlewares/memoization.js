"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cache_1 = require("./cache");
exports.memoizationMiddleware = ({ memoizedCache }) => {
    return async (ctx, next) => {
        if (!cache_1.isLocallyCacheable(ctx.config, cache_1.CacheType.Any) || !ctx.config.memoizable) {
            return await next();
        }
        const key = cache_1.cacheKey(ctx.config);
        const isMemoized = !!memoizedCache.has(key);
        if (isMemoized) {
            const memoized = await memoizedCache.get(key);
            ctx.memoizedHit = isMemoized;
            ctx.response = memoized.response;
            return;
        }
        else {
            const promise = new Promise(async (resolve, reject) => {
                try {
                    await next();
                    resolve({
                        cacheHit: ctx.cacheHit,
                        response: ctx.response,
                    });
                }
                catch (err) {
                    reject(err);
                }
            });
            memoizedCache.set(key, promise);
            await promise;
        }
    };
};
