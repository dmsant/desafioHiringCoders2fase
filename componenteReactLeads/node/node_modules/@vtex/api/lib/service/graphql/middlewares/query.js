"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const co_body_1 = require("co-body");
const ramda_1 = require("ramda");
const url_1 = require("url");
const constants_1 = require("../../../constants");
const parseVariables = (query) => {
    if (query && query[constants_1.BODY_HASH]) {
        return null;
    }
    if (query && typeof query.variables === 'string') {
        query.variables = JSON.parse(query.variables);
    }
    return query;
};
const queryFromUrl = ramda_1.compose(parseVariables, ramda_1.prop('query'), ramda_1.partialRight(url_1.parse, [true]));
async function parseQuery(ctx, next) {
    const { request, req } = ctx;
    let query;
    if (request.is('multipart/form-data')) {
        query = request.body;
    }
    else if (request.method.toUpperCase() === 'POST') {
        query = await co_body_1.json(req);
    }
    else {
        query = queryFromUrl(request.url) || await co_body_1.json(req);
    }
    ctx.graphql.query = query;
    await next();
}
exports.parseQuery = parseQuery;
